<!DOCTYPE html>
<html>
<head>
	<title>cacaoweb Manager</title>
	<meta charset=utf-8 />
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
	<link rel="stylesheet" href="css/style.css" />
	<link rel="stylesheet" href="css/ui-darkness/jquery-ui-1.8.17.custom.css" />
	<link rel="stylesheet" href="css/ui.jqgrid.css" />
	
	<script src="js/jquery-1.7.1.min.js"></script>
	<script src="js/jquery-ui-1.8.17.custom.min.js"></script>
	<script src="js/jquery.progressbar.min.js"></script>
	<script src="js/grid.locale-en.js"></script>
	<script src="js/jquery.jqGrid.min.js"></script>
</head>
<body>

	<noscript>This page will NOT work because Javascript is not enabled</noscript>
		
	<div class="container alogin">
		<div class="wrapper">
			<div class="content">
				
				<div class="header">
					<div class="header_top">
						<div class="logo"><a href="./"><img src="img/logo.png"/></a>
						</div>
						
						<div class="logout_panel">
							<div class="welcome_meun cp_word">Welcome <a class="useremail" href="/my_profile.php">ivan</a>  |  <a class="logout" href="/logout.php">Logout</a>
							</div>
						</div>  
						<div class="clear"/>
					</div> <!-- header_top -->
					<!--- Nav links --->
					<div class="meun"> 
						<button id="dashboardtab_btn">Dashboard</button>
						<button id="uploadtab_btn">Upload</button>
						<button id="redeemtab_btn">Redeem</button>
						<button id="earningstab_btn">Earnings</button>
						<button id="statisticstab_btn">Statistics</button>
						<button id="videomanagertab_btn">Files Manager</button>
					</div>
					<!--- End of Nav links --->
				</div>
				
				<div class="clear"></div>
				
				<div id="leftcolumn">
				</div>
				
				<div id="maincontent">
				
				<div id="dashboard">
					<div class="authbox" style="display:none">
						<div class="auth-notification"></div>
						<div id="buycredits-form" class="buycredits hidden">
							<form action="https://www.paypal.com/cgi-bin/webscr" id="depositform" method="post">
								<div class="form-field clear">
									<p id="numberofcreditstobuy"></p>
								</div>
								<div class="form-field clear">
									<input name="form[radio]" id="radio1" class="radio" type="radio" value="50" checked="true"><label for="radio1">50 credits = 5€</label>
									<input name="form[radio]" id="radio2" class="radio" type="radio" value="150"><label for="radio2">150 credits = 10€</label>
									<input name="form[radio]" id="radio3" class="radio" type="radio" value="400"><label for="radio3">400 credits = 20€</label>
									<div class="clear">
										<button name="submit" type="submit" id="submitpaypal"></button>
									</div>	
								</div><!-- /.form-field -->		
									


								<div id="paypalcart">
									<input name="cmd" value="_cart" type="hidden">
									<input name="upload" value="1" type="hidden">
									<input name="business" value="contact@cacaoweb.org" type="hidden">
									<input name="currency_code" value="EUR" type="hidden">
									<input name="cpp_header_image" value="http://cacaoweb.org/images/logonew.png" type="hidden">
									<input name="item_name_1" value="50 Credits" type="hidden">
									<input name="quantity_1" value="1" type="hidden">
									<input name="amount_1" value="5" type="hidden">
								</div>							
							
							</form>
						</div>
						<div class="auth-buttons">
							<button onclick="javascript:login()" id="loginbtn"></button>
							<button onclick="javascript:register()" id="createbtn"></button>
						</div>
						<div id="login-form" title="Login">
							<p id="validateTipsLogin"></p>
							<form>
							<fieldset>
								<label for="name"></label>
								<input type="text" name="name" id="loginname" class="text ui-widget-content ui-corner-all" />
								<label for="password"></label>
								<input type="password" id="loginpassword" value="" class="text ui-widget-content ui-corner-all" />
							</fieldset>
							</form>
						</div>
						<div id="createuser-form" title="">
							<p class="validateTips"></p>
							<form>
							<fieldset>
								<label for="name"></label>
								<input type="text" name="name" id="registername" class="text ui-widget-content ui-corner-all" />
								<label for="password"></label>
								<input type="password" name="password" id="registerpassword" value="" class="text ui-widget-content ui-corner-all" />
								<label for="email">Email</label>
								<input type="email" name="email" id="email" value="" class="text ui-widget-content ui-corner-all" placeholder="optional email address"/>
							</fieldset>
							</form>
						</div>
					</div>
				</div>
				
				
				
				<div id="upload" style="display:none">
				
					<h2 id="h2newupload"></h2>
					<div id="upload-tabs">
						<ul>
							<li><a href="#tabs-browse" id="browse-tab"></a></li>
							<li><a href="#tabs-remote" id="remote-upload-tab"></a></li>
							<li><a href="#tabs-ftp" id="ftp-upload-tab"></a></li>
						</ul>
						<div id="tabs-browse">
							<div class="addupload">
								<div id="upload_frame">
								
								</div>
								<p>
									<label for="file" id="smallupload"></label>
									<div id="filewithpath">
										<input name="file" id="file" size="40"></input>
										<button tabindex="1" value="Choose" onclick="javascript:choose()" id="choose"></button>
									</div>
									<form method='POST' enctype='multipart/form-data' accept-charset="UTF-8" action='' id="formupload" style="display:none">
										<input name="file" type="file" size="40" value="" />
										<p id="smalllargefile"></p>
									</form>
								</p>
							</div>
							<div class="restrictedinfo">
								<div class="meta-fields">
									<p>
									<label for="paidcontent" id="paidcontentsmall"></label>
									<input name="paidcontent" id="paidcontent" type="checkbox" />
									</p>
									<div id="paidcontentdetails">
										<p>
										<label for="preview" id="previewsmall"></label>
										<input name="preview" id="preview" type="checkbox" checked="true" />
										</p>
										<p>
										<label for="numberofcredits" id="numberofcreditssmall"></label>
										<select id="numberofcredits">
											<option value="1">1</option>
											<option value="2">2</option>
											<option value="5">5</option>
											<option value="10">10</option>
											<option value="20">20</option>
										</select>
										</p>
									</div>
								</div>
							</div>
						</div>
						<div id="tabs-remote">
							<div class="addupload">
								<p>
									<label for="file" id="smallremoteupload"></label>
									<input name="url" id="url" size="50"></input>
								</p>
								<p>
									<small><div id="examplesupload"></div>http://www.videobb.com/video/uGR5SO24apvI<br>http://www.videozer.com/video/6Fnpr<br>http://myspace.someserver.com/myvideo.mp4</small>
								</p>
							</div>
						</div>
						<div id="tabs-ftp">
							<div class="addupload">
								<p>
									<small id="ftpuploaddescr"></small>
								</p>
								<p>
									<label for="filelink" id="smallfilelink"></label>
									<input name="filelink" id="filelink" size="50"></input>
								</p>
								<p>
									<label for="numberofcredits" id="numberofcreditssmallftp"></label>
									<select id="numberofcreditsftp">
										<option value="0">0</option>
										<option value="1">1</option>
										<option value="2">2</option>
										<option value="5">5</option>
										<option value="10">10</option>
										<option value="20">20</option>
									</select>
								</p>
							</div>
						</div>
						<div id="metadatachanger" class="filemeta">
							<h3 id="uploadmeta"></h3>
							<div class="meta-fields">
								<div class="contenttypediv">
									<label for="contenttype" id='smallcontenttype'><small></small></label>
									<select id="contenttype">
										<option value="" id="blank"></option>
										<option value="movie" id="movie"></option>
										<option value="tvshow" id="tvshow"></option>
										<option value="anime" id="anime"></option>
										<option value="documentary" id="documentary"></option>
										<option value="music" id="music"></option>
										<option value="file" id="filecategory"></option>
									</select>
								</div>
								<div class="languagediv">
									<label for="language" id="smalllanguage"></label>
									<select id="language">
										<option value=""></option>
										<option value="en">English</option>
										<option value="fr">Français</option>
										<option value="es">Español</option>
										<option value="it">Italiano</option>
										<option value="pt">Português</option>
										<option value="de">Deutsch</option>
										<option value="hu">Magyar</option>
										<option value="pl">Polski</option>
										<option value="ru">Россию</option>
										<option value="ar">العربية</option>
										<option value="cn">越南</option>
										<option value="hi">हिन्दी</option>
										<option value="jp">日本</option>
										<option value="vn">Việt</option>
									</select>
								</div>
								<div id="titlefield">
									<label for="title" id="smalltitle"></label>
									<input type="text" name="title" id="title" tabindex="2" size="50" />
								</div>
								<div>
									<label for="subtitles" id="smallsubtitles"></label>
									<select id="subtitles">
										<option value=""></option>
										<option value="en">English</option>
										<option value="fr">Français</option>
										<option value="es">Español</option>
										<option value="it">Italiano</option>
										<option value="pt">Português</option>
										<option value="de">Deutsch</option>
										<option value="hu">Magyar</option>
										<option value="pl">Polski</option>
										<option value="ru">Россию</option>
										<option value="ar">العربية</option>
										<option value="cn">越南</option>
										<option value="hi">हिन्दी</option>
										<option value="jp">日本</option>
										<option value="vn">Việt</option>
									</select>
								</div>
								<div id="yeardetails" style="display:none">
									<p>
										<label for="year" id="smallyear"></label>
										<input id="year" type="text" maxlength="4" size="4"  type="number" min="1900" max="2100"/>
									</p>
								</div>
								<div id="tvshowdetails" style="display:none">
									<small><span id="addashow"></span></small>
								</div>
								<div id="seasondetails" style="display:none">
									<p>
										<label for="season" id="smallseason"></label>
										<input id="season" type="text" maxlength="2" size="2"  type="number" min="1" max="20"/>
									</p>
								</div>
								<div id="episodedetails" style="display:none">
									<p>
										<label for="episode" id="smallepisode"></label>
										<input id="episode" type="text" maxlength="2" size="2" type="number" min="1" />
									</p>
								</div>
								<p>
									<label>&nbsp;</label>
									<button id="submit" onclick="submit()"></button>
								</p>
							</div>
						</div>
					</div>
				
				</div>
				
				
				<div id="redeem" style="display:none">
					<div>Currently in development</div>
				</div>
				
				<div id="earnings" style="display:none">
					<div>Currently in development</div>
				</div>
				
				<div id="statistics" style="display:none">
				
				</div>
				
				
				
				<!--- Video Manager --->
				<div id="videomanager" style="display:none">
					<!--- jqGrid placeholder --->
					<div id="filesmanagergrid">
						<table id="list1"></table>
						<div id="pager1"></div>
					</div>
					

				</div>
				<!--- End Video Manager --->
				
				
				</div>
				
			</div>
		</div>
	</div>	

	
	<script src="js/languagestrings.js"></script>
	<script>	
		var lang;
		var fb_lang;
		if (navigator.userLanguage) { // Explorer
			fb_lang = navigator.userLanguage;
		} else if (navigator.language) { // FF
			fb_lang = navigator.language;
		}
		lang = fb_lang.substring(0, 2);
		switch (lang) {
			case 'en':
				break;
			case 'fr':
				break;
			case 'it':
				break;
			case 'pl':
				break;
			case 'es':
				break;
			default:
				lang = 'en';
		}
		
		/** 
		  translation of the interface strings
		*/
		
		//document.getElementsByTagName('title').item(0).innerHTML = langstrings[lang]['cacaowebadmin'];
		document.getElementById('h2newupload').innerHTML = langstrings[lang]['newupload'];
		document.getElementById('examplesupload').innerHTML = langstrings[lang]['examples'];
		document.getElementById('smallupload').innerHTML = langstrings[lang]['smallupload'];
		document.getElementById('smallremoteupload').innerHTML = langstrings[lang]['smallremoteupload'];
		document.getElementById('choose').innerHTML = langstrings[lang]['choose'];
		document.getElementById('smalllargefile').innerHTML = langstrings[lang]['smalllargefile'];
		document.getElementById('remote-upload-tab').innerHTML = langstrings[lang]['remoteupload'];
		document.getElementById('browse-tab').innerHTML = langstrings[lang]['browse'];
		document.getElementById('ftp-upload-tab').innerHTML = 'FTP';
		document.getElementById('uploadmeta').innerHTML = langstrings[lang]['uploadmeta'];
		document.getElementById('movie').innerHTML = langstrings[lang]['movie'];
		document.getElementById('tvshow').innerHTML = langstrings[lang]['tvshow'];
		document.getElementById('anime').innerHTML = langstrings[lang]['anime'];
		document.getElementById('documentary').innerHTML = langstrings[lang]['documentary'];
		document.getElementById('music').innerHTML = langstrings[lang]['music'];
		document.getElementById('filecategory').innerHTML = langstrings[lang]['file'];
		document.getElementById('smallcontenttype').innerHTML = langstrings[lang]['smallcontenttype'];
		document.getElementById('smalllanguage').innerHTML = langstrings[lang]['smalllanguage'];
		document.getElementById('smallsubtitles').innerHTML = langstrings[lang]['smallsubtitles'];
		document.getElementById('smalltitle').innerHTML = langstrings[lang]['smalltitle'];
		document.getElementById('smallseason').innerHTML = langstrings[lang]['smallseason'];
		document.getElementById('smallepisode').innerHTML = langstrings[lang]['smallepisode'];
		document.getElementById('smallyear').innerHTML = langstrings[lang]['smallyear'];
		document.getElementById('submit').innerHTML = langstrings[lang]['submit'];
		document.getElementById('loginbtn').innerHTML = langstrings[lang]['login'];
		document.getElementById('createbtn').innerHTML = langstrings[lang]['create'];
		document.getElementById('paidcontentsmall').innerHTML = langstrings[lang]['paidcontentsmall'];
		document.getElementById('previewsmall').innerHTML = langstrings[lang]['previewsmall'];
		document.getElementById('numberofcreditssmall').innerHTML = langstrings[lang]['numberofcreditssmall'];
		document.getElementById('numberofcreditssmallftp').innerHTML = langstrings[lang]['numberofcreditssmall'];
		document.getElementById('numberofcreditstobuy').innerHTML = langstrings[lang]['numberofcreditstobuy'];
		document.getElementById('submitpaypal').innerHTML = langstrings[lang]['buywithpaypal'];
		document.getElementById('smallfilelink').innerHTML = langstrings[lang]['smallfilelink'];
		document.getElementById('ftpuploaddescr').innerHTML = langstrings[lang]['ftpuploaddescr'];
		
			
	</script>
	

	<script> 
		jQuery().ready(function (){
			var lastsel;
			jQuery("#list1").jqGrid({
				url:'getuploadsjson.php',
				datatype: "json",
				colNames:[ ' ', 'Title', 'Date', 'Length', 'Paid file', 'Price'],
				colModel:[
					{name: 'myac', width:80, fixed:true, sortable:false, resize:false, formatter:'actions',formatoptions:{keys:true}},
					{name:'title',index:'title', width:200 },
					{name:'datecreated',index:'datecreated', width:90 },
					{name:'length',index:'length', width:60, align:"right", sortable:false },
					{name:'paidfile',index:'paidfile', width:60, align:"center",formatter: 'checkbox' },
					{name:'price',index:'price', width:60, align:"right", editable:true }
					],
				rowNum:10,
				autowidth: true,
				rowList:[10,20,30],
				pager: jQuery('#pager1'),
				sortname: 'datecreated',
				width: 700,
				height: "100%",
				viewrecords: true,
				sortorder: "desc",
				caption:"My Files",
				onSelectRow: function(id){
					if (id != lastsel) {
						populateMetaFields(id);
						lastsel = id;
					}
				},
				editurl : 'updatedata.php'
			}).navGrid('#pager1',{edit:false,add:false,del:false});
		});
	</script> 

	<script>
		$("label[for=name]").text(langstrings[lang]['name']);
		$("label[for=password]").text(langstrings[lang]['password']);
	
		function includeScript(filename, scriptname) {
			var htmlDoc = document.getElementsByTagName('body').item(0);
			var scriptblock = document.getElementById(scriptname); 
			if (scriptblock) {
				htmlDoc.removeChild(scriptblock);
			}
			var script = document.createElement("script");
		
			script.id = scriptname;
			script.src = filename;
			script.type = 'text/javascript';
			htmlDoc.appendChild(script);
		}
		function escapestring(str) {
			if (str) {
				return str.replace(/([ #;&,.+*~\':"!^$[\]()=>|\/@])/g,'\\$1')
			} else {
				return str;
			}
		}
		function ajaxrequest(link) {
			$.ajax({
				url: link,
				success: function() {}
			});
		}		
		

	

		
		function deleteDownload(provider, videoid) {
			$.ajax({
				url: provider + "/delete.caml?videoid=" + videoid,
				success: getdownloads()
			});
		}
		function deleteFileDownload(fileid) { // TODO: faire tout ca avec un this et un obj, c'est mieux
			$.ajax({
				url: "file/delete.caml?fileid=" + fileid,
				success: getdownloads()
			});
		}
		function removePublishedFile(fileid) {
			$.ajax({
				url: "file/delete.caml?fileid=" + fileid,
				success: function () { getcurrentuploads(); getalluploads(); }
			});
		}


		
		/** 
		  this function adds an upload with its details to the myuploads list
		  if the row is already here then just the progress bar is updated
		*/
		function addtomyuploads(rowid, fileid, title, season, episode, progress) {
			if ($("div[rowupid=" + escapestring(rowid) + "]").length > 0) {
				if (progress > -1) { $("div[rowupid=" + escapestring(rowid) + "]").find(".uploadprogressbar").progressBar(progress); }
			} else {
				var showdetails = '';
				if (season > 0 && episode > 0) {
					showdetails = ' S' + season + 'E' + episode;
				}
				var rowtitle = '<div class="title">' + title + showdetails + '</div>';
				var rowprogress = '<div class="progress"><div class="uploadprogressbar"></div></div>';
				var rowdelete = "<div class='delete'><a class='deletebutton' href='#' title='delete' onclick=\"removePublishedFile('" + fileid + "')\"></a></div>";
				var rowshowlink = "<div class='showlink'><a href='#' onclick=\"toggleLink(event, this)\">" + langstrings[lang]['showlink'] + "</a></div>";
				var rowlinks = "<div class='linkdisplay' style='display:none'><div>" + langstrings[lang]['smalllink'] + "</div><input name=\"link\" id=\"link\" size=\"80\"></input><div><small>" + langstrings[lang]['smallembed'] + "</small></div><textarea name=\"embed\" id=\"embed\" rows=\"4\" cols=\"60\"></textarea><div><small>Web</small> " + langstrings[lang]['smalllink'] + "</div><input name=\"externallink\" id=\"externallink\" size=\"80\"></input></div>";
				var link = 'http://127.0.0.1:4001/?f=' + fileid;
				var externallink = 'http://watch.cacaoweb.org/?play=1&videoid=' + fileid;
				var embed = '<object width="640" height="360"><param name="allowFullScreen" value="true" /><param name="flashvars" value="file=' + link + '" /><param name="movie" value="http://cacaoweb.org/player.swf" /><embed src="http://cacaoweb.org/player.swf" flashvars="file=' + link + '" width="640" height="360" allowFullScreen="true" /></object>';
				var div = document.createElement("div"); // obligé de créer un objet dans le DOM pour que la progressbar fonctionne
				div.className = "row";
				div.setAttribute('rowupid', rowid);
				div.setAttribute("colspan", "4");
				div.innerHTML = rowtitle  + rowprogress + rowdelete + rowshowlink + rowlinks;
				$("#myuploads").append(div);
				if (fileid != '') {
					$(div).find(".linkdisplay > #link").val(link);
					$(div).find(".linkdisplay > #externallink").val(externallink);
					$(div).find(".linkdisplay > textarea").val(embed);
				}
				if (progress == -1) { progress = 100; }; // TODO: a enlever car ça doit être calculé par moi même 
				$(div).find(".uploadprogressbar").progressBar(progress, { showText: false, boxImage: 'progressbar.gif', barImage: { 0:	'progressbg_red.gif', 30: 'progressbg_orange.gif', 70: 'progressbg_green.gif' }});
			}
		
		}
		function toggleLink(e, o) {
			var linksdiv = o.parentNode.nextSibling;
			$(linksdiv).toggle('fast');
		}
		function parseXMLuploads(xml) {
			var uploads = Array();
			$(xml).find("fileitem").each(function() {
				var item = {'fileid': $(this).find("fileid").text(), 
							'length': Math.floor($(this).find("length").text() / 1000000) + " Mo",
							'progress': $(this).find("progress").text(),
							'bandwidth': $(this).find("bandwidth").text(),
							'title': $(this).find("title").text() };
				uploads.push(item);
			});
			/* remove elements of the DOM that have been removed from the uploads list anymore (deleted) */
			/*$('div[rowupid]').each(function() {
				var id = $(this).attr('rowupid');
				
				var b = false;
				$.each(uploads, function (i, fileitem) {
					if (fileitem.fileid == id) { b = true; }
				});
				
				if (!b) {
					$(this).remove(); TODO
				}
			});*/
			$.each(uploads, function (i, item) {
				addtomyuploads(item.fileid, item.fileid, item.title, 0, 0, item.progress);
			});
			if ($('#myuploads').children().length == 0) {
				$("#uploads").hide();
			} else {
				$("#uploads").show();
			}
			
		}
		
		function getcurrentuploads() {
			$.ajax({
				url: "uploads",
				dataType: "xml",
				success: parseXMLuploads
			});
		}
		

		
		/**
		  after the function "getalluploads()" is called,
		  the remote server answers with a script that first sets up variables "remoteuploads", "directuploads", "transcodeduploads" 
		  and then calls the function "getuploadscallback()" to parse the variable "remoteuploads" and show the result to the user
		 */
		var currentuploadposition = 0;
		function getuploadscallback() {
			$.each(remoteuploads, function (i, item) {
				var realtitle = '';
				if (item.title == '') {
					var provider = '';
					if (item.provider == 0) { 
						provider = 'http://megavideo.com/?v='; 
					} else if (item.provider == 1) { 
						provider = 'http://videobb.com/video/';
					} else if (item.provider == 2) { 
						provider = 'http://videozer.com/video/';
					} else if (item.provider == 3) { 
						provider = 'http://mixturecloud.com/video=';
					} else {
						alert("unknown provider");
					}
					realtitle = provider + item.videoid;
				} else {
					realtitle = item.title;
				}
				
				var rowid = '';
				if (item.fileid == '') { rowid = item.videoid; } else { rowid = item.fileid; }

				var progress = 10;
				if (item.fileid != '') { progress = 100; }
				
				addtomyuploads(rowid, item.fileid, realtitle, item.season, item.episode, progress);
			});
			$.each(directuploads, function (i, item) {
				addtomyuploads(item.fileid, item.fileid, item.title, item.season, item.episode, -1);
			});
			$.each(transcodeduploads, function (i, item) {
				addtomyuploads(item.fileid, item.fileid, item.title, item.season, item.episode, 100);
			});
			
			/** shows the next and previous links to page the list of uploads */
			if (remoteuploads.length + directuploads.length + transcodeduploads.length > 30) {
				var newpos = currentuploadposition + 30;
				$('#uploadslistnext').html('<a href="#" onclick="getalluploads(\'' + newpos + '\')">' + langstrings[lang]['next'] + '</a>');
				$('#uploadslistnext').show();
			} else {
				$('#uploadslistnext').hide();
			}
			if (currentuploadposition > 0) {
				var newpos = currentuploadposition - 30;
				$('#uploadslistprevious').html('<a href="#" onclick="getalluploads(\'' + newpos + '\')">' + langstrings[lang]['previous'] + '</a>');
				$('#uploadslistprevious').show();
			} else {
				$('#uploadslistprevious').hide();
			}
		}
		function getalluploads(pos) {
			currentuploadposition = pos;
			includeScript('http://localhost/user/getuploads.php?pos=' + pos, 'getuploadscript');
		}
		function uploadcallback() {
			getalluploads(currentuploadposition);
			alert("upload done successfully");
		}
		
		$(function () {
			/** callback is isloggedincallback(isloggedin, username, money) */
			//includeScript('http://localhost/user/isloggedin.php', 'isloggedinscript');
			//getalluploads(0);
		});
	
		
		
		/**
		  Files Manager
		*/
		
		function populateMetaFields(id) {
			$.ajax({
				url: "getuploaddetails.php?id=" + id,
				success: function(details) {
					alert(details.fileid);
				}
			});
		}
		
		
		
		
		
	
		/** 
		  upload management
		*/
		
		function submit() {
			var selectedtab = $( "#upload-tabs" ).tabs( "option", "selected" );
			if (selectedtab == 0) { // Browse
				if ($('#contenttype').val() == 'movie' || $('#contenttype').val() == 'tvshow' || $('#contenttype').val() == 'anime' || $('#contenttype').val() == 'documentary') { // si le fichier est une vidéo, on envoie au service de transcodage
					/* uploadid: some unique number for the user to track the progress of the upload */
					var uploadid = Math.floor(Math.random() * 1000000000);
					var actionurl = "http://h264stage.com/uploadscripts/upload?cacaowebupload=1&uploadid=" + uploadid + '&user=' + encodeURIComponent(username) + '&contenttype=' + $('#contenttype').val() + '&language=' + $('#language').val() + '&subtitles=' + $('#subtitles').val() + '&title=' + encodeURIComponent($('#title').val()) + '&season=' + $('#season').val() + '&episode=' + $('#episode').val() + '&year=' + $('#year').val();
					if ($('#paidcontent').is(':checked')) {
						var previewallowed = 0;
						if ($('#preview').is(':checked')) { previewallowed = 1; }
						actionurl = actionurl + '&numberofcredits=' + $('#numberofcredits').val() + '&previewallowed=' + previewallowed;
					}
					/* we submit the form, which uploads the file to the server */
					$("#upload_frame").append('<iframe name="myiframe' + uploadid + '" style="display:none"></iframe>');
					$("#formupload").attr('target', 'myiframe' + uploadid);
					$("#formupload").attr('action', actionurl);
					$("#formupload").submit();
					/* we insert an iframe to show a progress bar so the user can track the upload progress */
					$("#upload_frame").append('<iframe height="30px" width="500px" frameborder="0" border="0" src="http://h264stage.com/uploadprogressframe.php?uploadid=' + uploadid + '" scrolling="no" scrollbar="no" allowtransparency="true"></iframe>'); 
				} else if ($('#file').val() != '') { // sinon upload direct
					/* if the file is not a multimedia file (video or audio), the file can be uploaded without transcoding it first */
					$.ajax({
						/* a request to the local cacaoweb instance to upload the file to the network in p2p fashion */
						url: "upload?filepath=" + encodeURIComponent($('#file').val()) + '&restricted=' + $('#paidcontent').is(':checked') + '&previewallowed=' + $('#preview').is(':checked'),
						/* requesting http://127.0.0.1:4001/upload?filepath=... from the local cacaoweb instance makes cacaoweb calculate the md5 of the file and return it */
						success: function(fileid) { /* fileid is the md5 (used as a unique identifier in the cacaoweb network) of the file */
							if (fileid == "") {
								alert("upload failed");
							} else {
								/* we upload the metadata of the file to the central server so these metadata can be incorporated in cacaoweb search engine */
								var actionstring = "fileid=" + fileid + "&contenttype=" + $('#contenttype').val() + '&language=' + $('#language').val() + '&subtitles=' + $('#subtitles').val() + '&title=' + encodeURIComponent($('#title').val()) + '&season=' + $('#season').val() + '&episode=' + $('#episode').val() + '&year=' + $('#year').val() + '&numberofcredits=' + $('#numberofcredits').val();
								includeScript('http://localhost/user/upload.php?' + actionstring, 'upload');
							}
						}
					});	
				}
			} else if (selectedtab == 1) { // Remote Upload
				/* we send the video information to the central database,
				   after that we do the remote upload through the local instance of cacaoweb */
				var url = $('#url').val();
				
				if (url.indexOf('megavideo.com/?v=') > -1) { // megavideo
					var pos1 = url.indexOf('v=');
					var megavideoid = url.substr(pos1 + 2);
					var actionstring = "providertype=0&videoid=" + megavideoid + "&contenttype=" + $('#contenttype').val() + '&language=' + $('#language').val() + '&subtitles=' + $('#subtitles').val() + '&title=' + encodeURIComponent($('#title').val()) + '&season=' + $('#season').val() + '&episode=' + $('#episode').val() + '&year=' + $('#year').val();
					includeScript('http://localhost/user/upload.php?' + actionstring, 'upload');
					$.ajax({
						url: "remoteupload?provider=0&videoid=" + megavideoid,
						success: function(data) {}
					});	
				} else if (url.indexOf('videobb.com/video/') > -1) { // videobb
					var pos1 = url.lastIndexOf('/');
					var videobbid = url.substr(pos1 + 1);
					var actionstring = "providertype=1&videoid=" + videobbid + "&contenttype=" + $('#contenttype').val() + '&language=' + $('#language').val() + '&subtitles=' + $('#subtitles').val() + '&title=' + encodeURIComponent($('#title').val()) + '&season=' + $('#season').val() + '&episode=' + $('#episode').val() + '&year=' + $('#year').val();
					includeScript('http://localhost/user/upload.php?' + actionstring, 'upload');
					$.ajax({
						url: "remoteupload?provider=1&videoid=" + videobbid,
						success: function(data) {}
					});	
				} else if (url.indexOf('videozer.com/video/') > -1) { // videozer
					var pos1 = url.lastIndexOf('/');
					var videozerid = url.substr(pos1 + 1);
					var actionstring = "providertype=2&videoid=" + videobbid + "&contenttype=" + $('#contenttype').val() + '&language=' + $('#language').val() + '&subtitles=' + $('#subtitles').val() + '&title=' + encodeURIComponent($('#title').val()) + '&season=' + $('#season').val() + '&episode=' + $('#episode').val() + '&year=' + $('#year').val();
					includeScript('http://localhost/user/upload.php?' + actionstring, 'upload');
					$.ajax({
						url: "remoteupload?provider=2&videoid=" + videozerid,
						success: function(data) {}
					});	
				} else if (url.indexOf('mixturecloud.com/video') > -1) { // mixture
					var pos1 = url.lastIndexOf('=');
					var videozerid = url.substr(pos1 + 1);
					var actionstring = "providertype=3&videoid=" + videobbid + "&contenttype=" + $('#contenttype').val() + '&language=' + $('#language').val() + '&subtitles=' + $('#subtitles').val() + '&title=' + encodeURIComponent($('#title').val()) + '&season=' + $('#season').val() + '&episode=' + $('#episode').val() + '&year=' + $('#year').val();
					includeScript('http://localhost/user/upload.php?' + actionstring, 'upload');
					$.ajax({
						url: "remoteupload?provider=3&videoid=" + videozerid,
						success: function(data) {}
					});	
				} else if (url.indexOf('http://') > -1 && url.indexOf('videobb.com') == -1 && url.indexOf('megavideo.com') == -1 && url.indexOf('videozer.com') == -1 && url.indexOf('mixturecloud.com') == -1) { // http direct
					/* TODO */
					alert("this link format is not supported at the moment");
				} else { // type inconnu
					alert(langstrings[lang]['linknotrecognized']);
				}
			} else if (selectedtab == 2) { // Metadata upload for previously uploaded files through ftp
				/* we upload the metadata of the file to the central server so these metadata can be incorporated in cacaoweb search engine */
				var actionstring = "filelink=" + $('#filelink').val() + "&contenttype=" + $('#contenttype').val() + '&language=' + $('#language').val() + '&subtitles=' + $('#subtitles').val() + '&title=' + encodeURIComponent($('#title').val()) + '&season=' + $('#season').val() + '&episode=' + $('#episode').val() + '&year=' + $('#year').val() + '&numberofcredits=' + $('#numberofcreditsftp').val();
				includeScript('http://localhost/user/upload.php?' + actionstring, 'upload');
			}
		}
			
		function choose() {
			if ($('#contenttype').val() == '') {
				alert("choose a category first");
			} else {
				$.ajax({
						url: "openfiledialogforupload",
						success: function(path) {
								$('#file').val(path);
							}
				});
			}
		}
	
		/** 
		  dynamic features for video metadata upload, update the shows list when needed
		*/
		function getshowscallback() {
			$('#title').remove();
			var select = $("<select></select>").attr('id','title');
			$.each(shows, function(id, show) {
				select.append('<option value="' + show.showname + '">' + show.showname  + '</option>');
			});
			$('#titlefield').append(select);
		}
		function updatefields() {
			var newcontenttype = $('#contenttype').val();
			if (newcontenttype == 'tvshow') {
				document.getElementById('smalltitle').innerHTML = langstrings[lang]['smallshowtitle'];
				$('#tvshowdetails').show("fast");
				$('#seasondetails').show("fast");
				$('#episodedetails').show("fast");
				$('#yeardetails').hide("fast");
				var contentlang = $('#language').val();
				if (contentlang == 'fr' || contentlang == 'en') {
					$('#addashow').html(langstrings[lang]['addashow']);
					$('#addashow').show();
					/* calls back getshowscallback() */
					includeScript('http://localhost/user/getshows.php?lang=' + contentlang, 'getshows');
				} else {
					$('#title').remove();
					$('#addashow').hide();
					var input = $("<input></input>").attr('type', 'text').attr('id', 'title').attr('size', '40');
					$('#titlefield').append(input);
				}
			} else {
				document.getElementById('smalltitle').innerHTML = langstrings[lang]['smalltitle'];
				$('#title').remove();
				var input = $("<input></input>").attr('type', 'text').attr('id', 'title').attr('size', '40');
				$('#titlefield').append(input);
				if (newcontenttype == 'anime') {
					$('#tvshowdetails').hide("fast");
					$('#seasondetails').hide("fast");
					$('#episodedetails').show("fast");
					$('#yeardetails').hide("fast");
				} else if (newcontenttype == 'movie') {
					$('#tvshowdetails').hide("fast");
					$('#seasondetails').hide("fast");
					$('#episodedetails').hide("fast");
					$('#yeardetails').show("fast");
				} else {
					$('#tvshowdetails').hide("fast");
					$('#seasondetails').hide("fast");
					$('#episodedetails').hide("fast");
					$('#yeardetails').hide("fast");
				}
			}
		}
		$('#contenttype').change(function() {
			updatefields();
		});
		
		$('#language').change(function() {
			updatefields();
		});
		
		$('#paidcontent').change(function() {
			if ($('#paidcontent').is(':checked')) {
				$('#paidcontentdetails').show();
			} else {
				$('#paidcontentdetails').hide();
			}
		});
		
		/** change the type of upload because in case of videos the file needs to be sent to the transcoding service */
		$('#contenttype').change(function() {
			if (($('#contenttype').val() == 'movie' || $('#contenttype').val() == 'tvshow' || $('#contenttype').val() == 'anime' || $('#contenttype').val() == 'documentary') && $("#upload-tabs").tabs("option", "selected") == 0) {
				$("#filewithpath").hide();
				$("#formupload").show();
			} else {
				$("#formupload").hide();
				$("#filewithpath").show();
			}
		});
		
		
		getcurrentuploads();
		
		function hidealltabs() {
			$("#dashboard").hide();
			$("#upload").hide();
			$("#redeem").hide();
			$("#earnings").hide();
			$("#statistics").hide();
			$("#videomanager").hide();
		
		}
		
		/** 
		  all types of jquery controls initialization
		*/
		$("button").button();
		$("#upload-tabs").tabs();
		
		$("#dashboardtab_btn").click(function() { hidealltabs(); $("#dashboard").show(); });
		$("#uploadtab_btn").click(function() { 
			hidealltabs(); $("#upload").show();
			$("#metadatachanger").appendTo("#upload-tabs");
		});
		$("#redeemtab_btn").click(function() { hidealltabs(); $("#redeem").show(); });
		$("#earningstab_btn").click(function() { hidealltabs(); $("#earnings").show(); });
		$("#statisticstab_btn").click(function() { hidealltabs(); $("#statistics").show(); });
		$("#videomanagertab_btn").click(function() { 
			hidealltabs(); $("#videomanager").show();
			$("#metadatachanger").appendTo("#videomanager");
		});
		
		

		
		/** 
		  authentication and account management functions like login and register 
		  */
		
		function register() {
			$('#createuser-form').dialog('open');
		}
		function login() {
			$('#login-form').dialog('open');
		}
		/** 
		  credits management 
		  */
		function showcreditsform() {
			$('#buycredits-form').dialog('open');
		}
		
		function updateTips( t ) {
			var tips = $( ".validateTips" );
			tips
				.text( t )
				.addClass( "ui-state-highlight" );
			setTimeout(function() {
				tips.removeClass( "ui-state-highlight", 1500 );
			}, 500 );
		}

		function checkLength( o, n, min, max ) {
			if ( o.val().length > max || o.val().length < min ) {
				o.addClass( "ui-state-error" );
				updateTips( "Length of " + n + " must be between " + min + " and " + max + "." );
				return false;
			} else {
				return true;
			}
		}

		function checkRegexp( o, regexp, n ) {
			if ( !( regexp.test( o.val() ) ) ) {
				o.addClass( "ui-state-error" );
				updateTips( n );
				return false;
			} else {
				return true;
			}
		}
		$("#depositform").submit(function() {
			var amount = $('input:radio[name=form[radio]]:checked').val();
			var price;
			switch (amount) {
				case "50":
					price = 5;
					break;
				case "150":
					price = 10;
					break;
				case "400":
					price = 20;
					break;
				default:
					price = 5;
			}
			$('input:hidden[name=amount_1]').val(price);
			$('input:hidden[name=item_name_1]').val(amount + ' Credits');
		});
		
		
		$("#buycredits-form").dialog({
			autoOpen: false,
			height: 250,
			width: 250,
			modal: true
		});
		
		
		
		var username;
		var money;
		var currentauthdialog;
		var allFields = $( [] ).add( $("#registername") ).add( $("#email") ).add( $("#registerpassword") );
		$("#createuser-form").attr("title", langstrings[lang]['create']);
		$("#createuser-form").dialog({
			autoOpen: false,
			height: 350,
			width: 350,
			modal: true,
			buttons: {
				'Create new user': function() {
					var bValid = true;
					allFields.removeClass('ui-state-error');

					bValid = bValid && checkLength($("#registername"), "username", 3, 16);
					bValid = bValid && checkLength($("#email"), "email", 6, 80);
					bValid = bValid && checkLength($("#registerpassword"), "password", 4, 16);

					bValid = bValid && checkRegexp($("#registername"), /^[a-z]([0-9a-z_])+$/i, "Username may consist of a-z, 0-9, underscores, begin with a letter.");
					// From jquery.validate.js (by joern), contributed by Scott Gonzalez: http://projects.scottsplayground.com/email_address_validation/
					bValid = bValid && checkRegexp($("#email"),/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i, "eg. albert@ducon.com");
					bValid = bValid && checkRegexp($("#registerpassword"), /^([0-9a-zA-Z])+$/, "Password field only allow : a-z 0-9");
					if (bValid) {
						includeScript('http://localhost/user/register.php?' + "username=" + $("#registername").val() + "&password=" + $("#registerpassword").val() + "&email=" + $("#email").val(), 'registerscript');
						username = $("#registername").val();
						currentauthdialog = $(this);
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
				}
			},
			close: function() {
				allFields.val('').removeClass('ui-state-error');
			}
		});
		
		$("#login-form").dialog({
			autoOpen: false,
			height: 350,
			width: 350,
			modal: true,
			buttons: {
				'Login': function() {
					$("#loginname").removeClass('ui-state-error');
					includeScript('http://localhost/user/login.php?' + "username=" + $("#loginname").val() + "&password=" + $("#loginpassword").val(), 'loginscript');
					username = $("#loginname").val();
					currentauthdialog = $(this);
				},
				'Cancel': function() {
					$(this).dialog('close');
				}
			},
			close: function() {
				$("#loginname").removeClass('ui-state-error');
			}
		});
		
		function registercallback(result) {
			if (result == 1) {
				$(".auth-buttons").hide();
				$(".auth-notification").text(langstrings[lang]['welcome'] + username + " !");
				$(".auth-notification").css('font-size', '12px');
				currentauthdialog.dialog('close');
			} else {
				$("#registername").addClass('ui-state-error');
				$(".validateTips").text('Username already exists, please choose another one.').addClass('ui-state-highlight');
				setTimeout(function() {
					$(".validateTips").removeClass('ui-state-highlight', 1500);
				}, 500);
			}
		}
		function logincallback(result) {
			if (result == 1) {
				getalluploads();
				currentauthdialog.dialog('close');
				includeScript('http://localhost/user/isloggedin.php', 'isloggedinscript');
			} else {
				$("#loginname").addClass('ui-state-error');
				$("#validateTipsLogin").text('Username or password is wrong').addClass('ui-state-highlight');
				setTimeout(function() {
					$("#validateTipsLogin").removeClass('ui-state-highlight', 1500);
				}, 500);
			}
		}
		function isloggedincallback(result, user, money, freevidshits, freevidscreditsearned, paidvidscreditsearned) {
			if (result == 1) {
				username = user;
				money = money;
				$(".auth-buttons").hide();
				$(".auth-notification").html(langstrings[lang]['welcome']  + user + " ! " + langstrings[lang]['mymoney'].replace('{1}', money));
				$(".auth-notification").css('font-size', '12px');
				$("#uploadviewsstatistics").html('<p>' + langstrings[lang]['statistics'] + ' :</p><p><i>' + langstrings[lang]['freeviewsearnings'] + ' : ' + freevidscreditsearned + ' credits (' + freevidshits + ' ' + langstrings[lang]['views'] + ')</i></p><p><i>' + langstrings[lang]['paidviewsearnings'] + ' : ' + paidvidscreditsearned + ' credits</i></p>');
			} else {
				$(".auth-buttons").show();
				$(".auth-notification").text(langstrings[lang]['notloggedin']);
			}
			$(".authbox").show();
		}
		
		
		$(function () {
			var url = window.location.href;
			if (url.indexOf("register") > -1) {
				register();
			}
			if (url.indexOf("buycredits") > -1) {
				showcreditsform();
			}
		});
		

    </script>

	
</body>
</html>
